<!DOCTYPE html>
<html lang="de">

<head>
   <meta charset="UTF-8">
   <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
   >
   <title>FIRMWARE UPDATE</title>
   <script src="static/tailwind.js"></script>
   <link
      href="static/flowbite.css"
      rel="stylesheet"
   />
   <script src="static/vue.js"></script>
   <style>
      [v-cloak] {
         display: none;
      }
   </style>
</head>

<body class="bg-gray-100 h-screen p-4">
   <div
      id="app"
      class="antialiased bg-gray-50"
      v-cloak
   >
      <nav class="bg-white border-b border-gray-200 px-4 py-2.5 fixed left-0 right-0 top-0 z-50">
         <div class="flex flex-wrap justify-between items-center">
            <div class="flex justify-start items-center">
               <h1 class="text-3xl font-bold pr-8">FIRMWARE UPDATE</h1>
               <div>
                  <span
                     class="inline-flex items-center px-2 py-1 me-2 text-sm font-medium text-green-800 bg-green-100 rounded"
                     :class="{'opacity-100': isConnected, 'opacity-10': !isConnected}"
                  >
                     Online
                  </span>
                  <span
                     class="inline-flex items-center px-2 py-1 me-2 text-sm font-medium text-red-800 bg-red-100 rounded"
                     :class="{'opacity-100': !isConnected, 'opacity-10': isConnected}"
                  >
                     Offline
                  </span>
               </div>
            </div>
         </div>
      </nav>

      <main class="p-4 h-auto pt-20">
         <div class="flex justify-between items-center mb-8">
            <button
               class="bg-blue-500 text-white px-4 py-2 rounded"
               onclick="window.history.back();"
            >
               Zurueck
            </button>
         </div>

         <!-- Current Firmware Info -->
         <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4">Aktuelle Firmware</h2>
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <span class="text-gray-600">Version:</span>
                  <span class="font-bold text-2xl ml-2">{{ firmwareInfo.version }}</span>
               </div>
               <div>
                  <span class="text-gray-600">Dateigroesse:</span>
                  <span class="font-bold ml-2">{{ formatSize(firmwareInfo.firmware_size) }}</span>
               </div>
            </div>
            <div
               v-if="!firmwareInfo.has_firmware"
               class="mt-4 text-yellow-600"
            >
               Keine Firmware hochgeladen
            </div>
         </div>

         <!-- Upload Form -->
         <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">Neue Firmware hochladen</h2>

            <!-- Drop Zone -->
            <div
               class="border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors"
               :class="{
                  'border-blue-500 bg-blue-50': isDragging,
                  'border-gray-300 hover:border-gray-400': !isDragging
               }"
               @dragover.prevent="isDragging = true"
               @dragleave.prevent="isDragging = false"
               @drop.prevent="handleDrop"
               @click="$refs.fileInput.click()"
            >
               <input
                  type="file"
                  ref="fileInput"
                  accept=".bin"
                  @change="handleFileSelect"
                  class="hidden"
               >
               <div v-if="!selectedFile">
                  <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                     <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <p class="mt-2 text-gray-600">.bin Datei hierher ziehen</p>
                  <p class="text-sm text-gray-500">oder klicken zum Auswaehlen</p>
               </div>
               <div v-else>
                  <p class="text-green-600 font-bold">{{ selectedFile.name }}</p>
                  <p class="text-sm text-gray-500">{{ formatSize(selectedFile.size) }}</p>
               </div>
            </div>

            <!-- Upload Button -->
            <div class="mt-6 flex gap-4">
               <button
                  @click="uploadFirmware"
                  :disabled="!selectedFile || isUploading"
                  class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded disabled:opacity-50 disabled:cursor-not-allowed"
               >
                  <span v-if="isUploading">Uploading...</span>
                  <span v-else>Firmware hochladen</span>
               </button>
               <button
                  v-if="selectedFile"
                  @click="clearSelection"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded"
               >
                  Abbrechen
               </button>
            </div>

            <!-- Success Message -->
            <div
               v-if="uploadSuccess"
               class="mt-4 p-4 bg-green-100 text-green-800 rounded"
            >
               Firmware erfolgreich hochgeladen! Neue Version: {{ uploadSuccess.version }}
            </div>

            <!-- Error Message -->
            <div
               v-if="uploadError"
               class="mt-4 p-4 bg-red-100 text-red-800 rounded"
            >
               {{ uploadError }}
            </div>
         </div>

         <!-- Info Box -->
         <div class="bg-blue-50 p-6 rounded-lg shadow-md mt-8">
            <h3 class="font-bold text-blue-800 mb-2">Wie funktioniert OTA?</h3>
            <ul class="text-blue-700 text-sm space-y-1">
               <li>1. Firmware hier hochladen (Version wird automatisch erhoeht)</li>
               <li>2. Nanos pruefen bei jedem Boot auf neue Firmware</li>
               <li>3. Update passiert automatisch wenn neue Version verfuegbar</li>
            </ul>
         </div>
      </main>
   </div>

   <script src="./static/flowbite.min.js"></script>

   <script type="module">
      const { createApp } = Vue

      const app = createApp({
         data() {
            return {
               environment: localStorage.getItem('environment') || 'hub.local:8000',
               isConnected: false,
               socket: null,
               firmwareInfo: {
                  version: 0,
                  has_firmware: false,
                  firmware_size: 0
               },
               selectedFile: null,
               isDragging: false,
               isUploading: false,
               uploadSuccess: null,
               uploadError: null
            }
         },

         methods: {
            connectWebSocket() {
               this.socket = new WebSocket(`ws://${this.environment}/ws`)
               this.socket.addEventListener('open', () => {
                  this.isConnected = true
               })
               this.socket.addEventListener('close', () => {
                  this.isConnected = false
                  setTimeout(() => this.connectWebSocket(), 5000)
               })
            },

            async loadFirmwareInfo() {
               try {
                  const response = await fetch(`http://${this.environment}/firmware/info`)
                  this.firmwareInfo = await response.json()
               } catch (error) {
                  console.error('Failed to load firmware info:', error)
               }
            },

            handleFileSelect(event) {
               const file = event.target.files[0]
               if (file && file.name.endsWith('.bin')) {
                  this.selectedFile = file
                  this.uploadSuccess = null
                  this.uploadError = null
               } else {
                  this.uploadError = 'Bitte eine .bin Datei auswaehlen'
               }
            },

            handleDrop(event) {
               this.isDragging = false
               const file = event.dataTransfer.files[0]
               if (file && file.name.endsWith('.bin')) {
                  this.selectedFile = file
                  this.uploadSuccess = null
                  this.uploadError = null
               } else {
                  this.uploadError = 'Bitte eine .bin Datei auswaehlen'
               }
            },

            clearSelection() {
               this.selectedFile = null
               this.uploadSuccess = null
               this.uploadError = null
               this.$refs.fileInput.value = ''
            },

            async uploadFirmware() {
               if (!this.selectedFile) return

               this.isUploading = true
               this.uploadError = null
               this.uploadSuccess = null

               try {
                  const formData = new FormData()
                  formData.append('file', this.selectedFile)

                  const response = await fetch(`http://${this.environment}/firmware/upload`, {
                     method: 'POST',
                     body: formData
                  })

                  if (!response.ok) {
                     throw new Error('Upload fehlgeschlagen')
                  }

                  const result = await response.json()
                  this.uploadSuccess = result
                  this.selectedFile = null
                  this.$refs.fileInput.value = ''

                  // Reload firmware info
                  await this.loadFirmwareInfo()
               } catch (error) {
                  console.error('Upload failed:', error)
                  this.uploadError = error.message || 'Upload fehlgeschlagen'
               } finally {
                  this.isUploading = false
               }
            },

            formatSize(bytes) {
               if (bytes === 0) return '0 B'
               const k = 1024
               const sizes = ['B', 'KB', 'MB', 'GB']
               const i = Math.floor(Math.log(bytes) / Math.log(k))
               return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
            }
         },

         mounted() {
            this.connectWebSocket()
            this.loadFirmwareInfo()
         }
      })

      app.mount('#app')
   </script>
</body>

</html>
